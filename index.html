<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mon…îk…î ‚Äî Dictionnaire multilingue</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700;800&family=DM+Sans:wght@400;500;600;700&family=Source+Serif+4:ital,wght@0,400;0,600;1,400&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:#F7F3ED}
    input::placeholder{color:#B8A88C}
    ::-webkit-scrollbar{width:4px}
    ::-webkit-scrollbar-thumb{background:#D4C8B4;border-radius:4px}
    @keyframes slideIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useRef, useEffect, useCallback } = React;

    const SUPABASE_URL = "https://haioiccujncsehadipzb.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhhaW9pY2N1am5jc2VoYWRpcHpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwMTczMjAsImV4cCI6MjA4NjU5MzMyMH0.ic0JlZ17hOpLOzth_E4YrR122EG4LN6T04TYMcV-_CU";

    async function supaFetch(table, params = "") {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${params}`, {
        headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` },
      });
      if (!res.ok) throw new Error(`Supabase error: ${res.status}`);
      return res.json();
    }

    async function supaCount(table, filter = "") {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}?select=id${filter ? '&' + filter : ''}`, {
        headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}`, Prefer: "count=exact", Range: "0-0" },
      });
      const range = res.headers.get("content-range");
      return range ? parseInt(range.split("/")[1]) : 0;
    }

    // Language colors/flags
    const LANG_THEMES = {
      "Lingala": { emoji: "üá®üá©", gradient: "linear-gradient(135deg, #2C5F2D, #4A8B4C)", accent: "#2C5F2D" },
      "Yoruba": { emoji: "üá≥üá¨", gradient: "linear-gradient(135deg, #1B5E20, #388E3C)", accent: "#1B5E20" },
    };
    const defaultTheme = { emoji: "üåç", gradient: "linear-gradient(135deg, #2C5F2D, #4A8B4C)", accent: "#2C5F2D" };

    // Geographic data for each language
    const LANG_GEO = {
      "Lingala": {
        regions: ["R√©publique D√©mocratique du Congo", "R√©publique du Congo", "Centrafrique", "Angola"],
        speakers: "~45 million",
        family: "Langue bantoue",
        description: "Langue v√©hiculaire majeure de l'Afrique centrale, parl√©e principalement le long du fleuve Congo. Lingua franca √† Kinshasa et Brazzaville.",
        color: "#2C5F2D",
        center: [-2, 22],
        cities: [
          { name: "Kinshasa", lat: -4.32, lon: 15.31, main: true },
          { name: "Brazzaville", lat: -4.27, lon: 15.28, main: false },
          { name: "Kisangani", lat: 0.52, lon: 25.19, main: false },
          { name: "Bangui", lat: 4.36, lon: 18.56, main: false },
          { name: "Mbandaka", lat: 0.05, lon: 18.26, main: false },
        ],
      },
      "Yoruba": {
        regions: ["Nigeria (Sud-Ouest)", "B√©nin", "Togo"],
        speakers: "~47 million",
        family: "Langue nig√©ro-congolaise",
        description: "L'une des plus grandes langues d'Afrique de l'Ouest. Langue du peuple Yoruba, riche en tradition orale, po√©sie et musique.",
        color: "#C4912E",
        center: [7.5, 4],
        cities: [
          { name: "Lagos", lat: 6.45, lon: 3.40, main: true },
          { name: "Ibadan", lat: 7.38, lon: 3.93, main: false },
          { name: "Cotonou", lat: 6.37, lon: 2.39, main: false },
          { name: "Abeokuta", lat: 7.16, lon: 3.35, main: false },
          { name: "Oshogbo", lat: 7.77, lon: 4.56, main: false },
        ],
      },
    };

    const MapIcon = () => (<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>);

    // Leaflet Map Component
    const LeafletMap = ({ selectedMapLang, onSelectLang }) => {
      const mapRef = useRef(null);
      const mapInstanceRef = useRef(null);
      const markersRef = useRef([]);

      useEffect(() => {
        if (mapInstanceRef.current) return; // already initialized

        // Load Leaflet CSS
        if (!document.getElementById('leaflet-css')) {
          const link = document.createElement('link');
          link.id = 'leaflet-css';
          link.rel = 'stylesheet';
          link.href = 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css';
          document.head.appendChild(link);
        }

        // Load Leaflet JS
        const loadLeaflet = () => {
          return new Promise((resolve) => {
            if (window.L) { resolve(); return; }
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js';
            script.onload = resolve;
            document.head.appendChild(script);
          });
        };

        loadLeaflet().then(() => {
          const L = window.L;
          const map = L.map(mapRef.current, {
            center: [3, 15],
            zoom: 4,
            minZoom: 3,
            maxZoom: 8,
            zoomControl: true,
            attributionControl: false,
          });

          // Use a clean, muted tile style
          L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            subdomains: 'abcd',
          }).addTo(map);

          mapInstanceRef.current = map;

          // Add city markers for each language
          Object.entries(LANG_GEO).forEach(([langName, geo]) => {
            geo.cities.forEach((city) => {
              const size = city.main ? 14 : 8;
              const icon = L.divIcon({
                className: '',
                html: `<div style="
                  width:${size}px; height:${size}px;
                  background:${geo.color};
                  border: 2px solid white;
                  border-radius: 50%;
                  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                  cursor: pointer;
                "></div>`,
                iconSize: [size, size],
                iconAnchor: [size/2, size/2],
              });

              const marker = L.marker([city.lat, city.lon], { icon }).addTo(map);

              // Tooltip
              const tooltipContent = city.main
                ? `<div style="font-family:'DM Sans',sans-serif;padding:4px 2px;">
                    <strong style="font-size:13px;color:${geo.color};">${city.name}</strong><br/>
                    <span style="font-size:11px;color:#6B7280;">${langName}</span>
                  </div>`
                : `<span style="font-family:'DM Sans',sans-serif;font-size:11px;">${city.name}</span>`;

              marker.bindTooltip(tooltipContent, {
                permanent: city.main,
                direction: 'top',
                offset: [0, -size/2 - 2],
                className: 'clean-tooltip',
              });

              marker.on('click', () => onSelectLang(langName));
              marker.langName = langName;
              marker.isMain = city.main;
              markersRef.current.push(marker);
            });
          });

          // Add custom tooltip style
          const style = document.createElement('style');
          style.textContent = `
            .clean-tooltip {
              background: white !important;
              border: 1px solid #E8E0D4 !important;
              border-radius: 8px !important;
              box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
              padding: 4px 8px !important;
              font-family: 'DM Sans', sans-serif !important;
            }
            .clean-tooltip:before { border-top-color: #E8E0D4 !important; }
            .leaflet-control-zoom a {
              background: white !important;
              color: #2D2118 !important;
              border-color: #E8E0D4 !important;
              font-family: 'DM Sans', sans-serif !important;
            }
          `;
          document.head.appendChild(style);
        });

        return () => {
          if (mapInstanceRef.current) {
            mapInstanceRef.current.remove();
            mapInstanceRef.current = null;
          }
        };
      }, []);

      // Fly to selected language
      useEffect(() => {
        if (!mapInstanceRef.current || !selectedMapLang) return;
        const geo = LANG_GEO[selectedMapLang];
        if (geo) {
          mapInstanceRef.current.flyTo(geo.center, 5, { duration: 1 });
        }

        // Highlight markers
        markersRef.current.forEach(m => {
          const el = m.getElement();
          if (!el) return;
          const dot = el.querySelector('div');
          if (!dot) return;
          if (m.langName === selectedMapLang) {
            dot.style.transform = m.isMain ? 'scale(1.4)' : 'scale(1.2)';
            dot.style.boxShadow = `0 0 0 4px ${LANG_GEO[m.langName].color}40, 0 2px 6px rgba(0,0,0,0.3)`;
          } else {
            dot.style.transform = 'scale(1)';
            dot.style.boxShadow = '0 2px 6px rgba(0,0,0,0.3)';
            dot.style.opacity = selectedMapLang ? '0.4' : '1';
          }
        });
      }, [selectedMapLang]);

      return (
        <div ref={mapRef} style={{
          width: "100%", height: 320, borderRadius: 16, overflow: "hidden",
          border: "1px solid #E8E0D4",
        }} />
      );
    };

    const SearchIcon = () => (<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>);
    const BookIcon = () => (<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>);
    const ArrowLeft = () => (<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg>);
    const ChevronRight = () => (<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M9 18l6-6-6-6"/></svg>);
    const VolumeIcon = () => (<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>);
    const GlobeIcon = () => (<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>);
    const GradIcon = () => (<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c0 1.1 2.7 2 6 2s6-.9 6-2v-5"/></svg>);
    const Spinner = () => (<div style={{display:"flex",justifyContent:"center",padding:40}}><div style={{width:32,height:32,border:"3px solid #E8E0D4",borderTopColor:"#2C5F2D",borderRadius:"50%",animation:"spin 0.8s linear infinite"}}/></div>);

    const SenseCard = ({ sense, index }) => (
      <div style={{ background:"white", borderRadius:16, padding:"20px 24px", marginBottom:12, border:"1px solid #E8E0D4", boxShadow:"0 1px 3px rgba(139,109,71,0.06)" }}>
        <div style={{ display:"flex", alignItems:"center", gap:10, marginBottom:12 }}>
          <span style={{ background:"#2C5F2D", color:"white", fontSize:11, fontWeight:700, padding:"3px 10px", borderRadius:20, letterSpacing:"0.05em", fontFamily:"'DM Mono', monospace" }}>SENS {index+1}</span>
          <span style={{ fontSize:22, fontWeight:700, color:"#2C5F2D", fontFamily:"'Playfair Display', serif" }}>{sense.dialect_word}</span>
          <button style={{ background:"#F0EBE3", border:"none", borderRadius:"50%", width:32, height:32, display:"flex", alignItems:"center", justifyContent:"center", cursor:"pointer", color:"#8B6D47", marginLeft:"auto", flexShrink:0 }} title="Audio (bient√¥t disponible)"><VolumeIcon /></button>
        </div>
        {sense.examples && sense.examples.length > 0 && (
          <div style={{ background:"#FDFBF7", borderRadius:12, padding:"14px 18px", borderLeft:"3px solid #D4A843" }}>
            <p style={{ margin:0, fontSize:15, color:"#5C4A2E", fontStyle:"italic", lineHeight:1.5, fontFamily:"'Source Serif 4', serif" }}>¬´ {sense.examples[0].sentence_dialect} ¬ª</p>
            <p style={{ margin:"8px 0 0", fontSize:13, color:"#9B8A6E", lineHeight:1.4, fontFamily:"'DM Sans', sans-serif" }}>{sense.examples[0].sentence_french}</p>
          </div>
        )}
      </div>
    );

    const WordDetail = ({ wordId, langName, onBack }) => {
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(true);
      useEffect(() => {
        (async () => {
          setLoading(true);
          try {
            const word = await supaFetch("words", `id=eq.${wordId}&select=*`);
            const senses = await supaFetch("senses", `word_id=eq.${wordId}&select=*,examples(*)&order=sense_number`);
            setData({ word: word[0], senses });
          } catch (e) { console.error(e); }
          setLoading(false);
        })();
      }, [wordId]);
      if (loading) return <Spinner />;
      if (!data) return <p style={{textAlign:"center",color:"#9B8A6E",padding:40}}>Erreur de chargement</p>;
      return (
        <div style={{ animation:"slideIn 0.25s ease-out" }}>
          <button onClick={onBack} style={{ display:"flex", alignItems:"center", gap:6, background:"none", border:"none", color:"#8B6D47", fontSize:14, fontWeight:600, cursor:"pointer", padding:"8px 0", marginBottom:8, fontFamily:"'DM Sans', sans-serif" }}><ArrowLeft /> Retour</button>
          <div style={{ background:"linear-gradient(135deg, #2C5F2D 0%, #1A3D1B 100%)", borderRadius:20, padding:"28px 28px 24px", marginBottom:20, position:"relative", overflow:"hidden" }}>
            <div style={{ position:"absolute", top:-30, right:-30, width:120, height:120, borderRadius:"50%", background:"rgba(255,255,255,0.04)" }}/>
            <div style={{ position:"absolute", bottom:-20, left:40, width:80, height:80, borderRadius:"50%", background:"rgba(255,255,255,0.03)" }}/>
            <span style={{ fontSize:12, color:"rgba(255,255,255,0.5)", fontWeight:600, letterSpacing:"0.12em", textTransform:"uppercase", fontFamily:"'DM Mono', monospace" }}>Fran√ßais ‚Üí {langName}</span>
            <h2 style={{ margin:"8px 0 4px", fontSize:36, fontWeight:800, color:"white", fontFamily:"'Playfair Display', serif", lineHeight:1.1 }}>{data.word.french_word}</h2>
            <span style={{ fontSize:13, color:"rgba(255,255,255,0.45)", fontFamily:"'DM Sans', sans-serif" }}>{data.senses.length} {data.senses.length > 1 ? "traductions" : "traduction"}</span>
          </div>
          {data.senses.map((sense, i) => <SenseCard key={sense.id} sense={sense} index={i} />)}
        </div>
      );
    };

    const ResultRow = ({ word, onClick }) => (
      <button onClick={onClick} style={{ display:"flex", alignItems:"center", justifyContent:"space-between", width:"100%", background:"white", border:"1px solid #E8E0D4", borderRadius:14, padding:"16px 20px", marginBottom:8, cursor:"pointer", textAlign:"left", transition:"all 0.15s", boxShadow:"0 1px 2px rgba(139,109,71,0.04)" }}
        onMouseOver={e => { e.currentTarget.style.borderColor="#D4A843"; e.currentTarget.style.boxShadow="0 2px 8px rgba(212,168,67,0.12)"; }}
        onMouseOut={e => { e.currentTarget.style.borderColor="#E8E0D4"; e.currentTarget.style.boxShadow="0 1px 2px rgba(139,109,71,0.04)"; }}>
        <div>
          <div style={{ fontSize:17, fontWeight:700, color:"#2D2118", fontFamily:"'Playfair Display', serif" }}>{word.french_word}</div>
          {word.dialect_words && <div style={{ fontSize:14, color:"#2C5F2D", marginTop:3, fontFamily:"'DM Sans', sans-serif", fontWeight:500 }}>{word.dialect_words}</div>}
        </div>
        <div style={{ color:"#C4B8A4", flexShrink:0 }}><ChevronRight /></div>
      </button>
    );

    function App() {
      // Language selection
      const [languages, setLanguages] = useState([]);
      const [selectedLang, setSelectedLang] = useState(null);
      const [loadingLangs, setLoadingLangs] = useState(true);

      // Dictionary state
      const [view, setView] = useState("lang_select");
      const [query, setQuery] = useState("");
      const [searchMode, setSearchMode] = useState("french");
      const [results, setResults] = useState([]);
      const [hasSearched, setHasSearched] = useState(false);
      const [loading, setLoading] = useState(false);
      const [selectedWordId, setSelectedWordId] = useState(null);
      const [browseLetter, setBrowseLetter] = useState(null);
      const [browseWords, setBrowseWords] = useState([]);
      const [stats, setStats] = useState({ words: 0, senses: 0 });
      const [wordOfDay, setWordOfDay] = useState(null);
      const [prevView, setPrevView] = useState("home");
      const [mapLang, setMapLang] = useState(null);
      // Courses state
      const [courses, setCourses] = useState([]);
      const [selectedCourse, setSelectedCourse] = useState(null);
      const [selectedLesson, setSelectedLesson] = useState(null);
      const [lessonItems, setLessonItems] = useState([]);
      const [currentCardIdx, setCurrentCardIdx] = useState(0);
      const [cardFlipped, setCardFlipped] = useState(false);
      const inputRef = useRef(null);
      const LETTERS = "A B C D E F G H I J K L M N O P Q R S T U V W X Y Z".split(" ");

      // Load languages on mount
      useEffect(() => {
        (async () => {
          try {
            const langs = await supaFetch("languages", "select=*&status=eq.active&order=name");
            // Get word counts per language
            const withCounts = await Promise.all(langs.map(async (l) => {
              const wc = await supaCount("words", `language_id=eq.${l.id}`);
              return { ...l, wordCount: wc };
            }));
            setLanguages(withCounts);
            // If only one language, skip selection
            if (withCounts.length === 1) {
              selectLanguage(withCounts[0]);
            }
          } catch (e) { console.error("Failed to load languages:", e); }
          setLoadingLangs(false);
        })();
      }, []);

      const selectLanguage = async (lang) => {
        setSelectedLang(lang);
        setView("home");
        // Load stats for this language
        try {
          const wc = await supaCount("words", `language_id=eq.${lang.id}`);
          const sc = await supaCount("senses", `word_id=in.(select id from words where language_id=eq.${lang.id})`);
          setStats({ words: wc, senses: sc || wc });

          const dayOffset = Math.floor(Date.now() / 86400000) % Math.max(wc, 1);
          const wotd = await supaFetch("words", `select=*,senses(dialect_word)&language_id=eq.${lang.id}&limit=1&offset=${dayOffset}`);
          if (wotd[0]) {
            setWordOfDay({ id: wotd[0].id, french_word: wotd[0].french_word, dialect_word: wotd[0].senses?.[0]?.dialect_word || "‚Äî" });
          }
        } catch (e) { console.error(e); }
      };

      const switchLanguage = () => {
        setView("lang_select");
        setSelectedLang(null);
        setQuery("");
        setResults([]);
        setHasSearched(false);
        setBrowseLetter(null);
        setBrowseWords([]);
        setWordOfDay(null);
        setStats({ words: 0, senses: 0 });
      };

      useEffect(() => {
        if (view === "search" && inputRef.current) setTimeout(() => inputRef.current?.focus(), 100);
      }, [view]);

      const langId = selectedLang?.id;
      const langName = selectedLang?.name || "";
      const theme = LANG_THEMES[langName] || defaultTheme;

      const doSearch = useCallback(async () => {
        const q = query.trim();
        if (!q || !langId) return;
        setLoading(true); setHasSearched(true);
        try {
          if (searchMode === "french") {
            const data = await supaFetch("words", `select=id,french_word,letter,senses(dialect_word)&language_id=eq.${langId}&french_word=ilike.*${encodeURIComponent(q)}*&order=french_word&limit=50`);
            setResults(data.map(w => ({ id: w.id, french_word: w.french_word, dialect_words: w.senses?.map(s => s.dialect_word).join(" ¬∑ ") || "" })));
          } else {
            const senseData = await supaFetch("senses", `select=id,dialect_word,word_id,words!inner(id,french_word,language_id)&words.language_id=eq.${langId}&dialect_word=ilike.*${encodeURIComponent(q)}*&limit=50`);
            const seen = new Set();
            const mapped = [];
            for (const s of senseData) {
              if (s.words && !seen.has(s.words.id)) {
                seen.add(s.words.id);
                mapped.push({ id: s.words.id, french_word: s.words.french_word, dialect_words: s.dialect_word });
              }
            }
            setResults(mapped);
          }
        } catch (e) { console.error(e); setResults([]); }
        setLoading(false);
      }, [query, searchMode, langId]);

      const loadBrowse = useCallback(async (letter) => {
        if (!langId) return;
        setBrowseLetter(letter); setLoading(true);
        try {
          const accentMap = { 'A':['A','√Ä','√Ç'], 'E':['E','√â','√ä','√à'], 'I':['I','√é','√è'], 'O':['O','√î'], 'U':['U','√ô','√õ','√ú'], 'C':['C','√á'] };
          const prefixes = accentMap[letter] || [letter];
          const orFilter = prefixes.map(p => `french_word.ilike.${encodeURIComponent(p + '%')}`).join(",");
          const data = await supaFetch("words", `select=id,french_word,senses(dialect_word)&language_id=eq.${langId}&or=(${orFilter})&order=french_word&limit=500`);
          setBrowseWords(data.map(w => ({ id: w.id, french_word: w.french_word, dialect_words: w.senses?.map(s => s.dialect_word).join(" ¬∑ ") || "" })));
        } catch (e) { console.error(e); setBrowseWords([]); }
        setLoading(false);
      }, [langId]);

      const openWord = (id, fromView) => { setPrevView(fromView || view); setSelectedWordId(id); setView("detail"); };

      return (
        <div style={{ maxWidth:480, margin:"0 auto", minHeight:"100vh", background:"#F7F3ED", fontFamily:"'DM Sans', sans-serif" }}>
          <div style={{ padding:"0 20px 100px" }}>

            {/* LANGUAGE SELECT */}
            {view === "lang_select" && (
              <div style={{ animation:"fadeIn 0.3s ease-out" }}>
                <div style={{ textAlign:"center", paddingTop:60, paddingBottom:40 }}>
                  <div style={{
                    width:72, height:72, borderRadius:20,
                    background:"linear-gradient(135deg, #2C5F2D, #4A8B4C)",
                    display:"flex", alignItems:"center", justifyContent:"center",
                    margin:"0 auto 16px", boxShadow:"0 8px 24px rgba(44,95,45,0.25)",
                    animation:"float 4s ease-in-out infinite",
                  }}><span style={{ fontSize:32 }}>üìñ</span></div>
                  <h1 style={{ fontFamily:"'Playfair Display', serif", fontSize:32, fontWeight:800, color:"#2D2118", margin:"0 0 4px", lineHeight:1.1 }}>Mon…îk…î</h1>
                  <p style={{ color:"#9B8A6E", fontSize:14, margin:"0 0 8px", fontWeight:500 }}>Dictionnaire des langues africaines</p>
                  <p style={{ color:"#B8A88C", fontSize:13 }}>Choisissez une langue</p>
                </div>

                {loadingLangs ? <Spinner /> : (
                  <div style={{ display:"flex", flexDirection:"column", gap:12 }}>
                    {languages.map(lang => {
                      const t = LANG_THEMES[lang.name] || defaultTheme;
                      return (
                        <button key={lang.id} onClick={() => selectLanguage(lang)} style={{
                          display:"flex", alignItems:"center", gap:16, width:"100%",
                          background:"white", border:"1px solid #E8E0D4", borderRadius:18,
                          padding:"22px 24px", cursor:"pointer", textAlign:"left",
                          transition:"all 0.2s", boxShadow:"0 2px 8px rgba(139,109,71,0.06)",
                        }}
                        onMouseOver={e => { e.currentTarget.style.transform="translateY(-2px)"; e.currentTarget.style.boxShadow="0 6px 20px rgba(139,109,71,0.1)"; }}
                        onMouseOut={e => { e.currentTarget.style.transform="translateY(0)"; e.currentTarget.style.boxShadow="0 2px 8px rgba(139,109,71,0.06)"; }}>
                          <div style={{ width:48, height:48, borderRadius:14, background:t.gradient, display:"flex", alignItems:"center", justifyContent:"center", flexShrink:0, fontSize:24 }}>{t.emoji}</div>
                          <div style={{ flex:1 }}>
                            <div style={{ fontSize:18, fontWeight:700, color:"#2D2118", fontFamily:"'Playfair Display', serif" }}>
                              Fran√ßais ‚Äî {lang.name}
                            </div>
                            <div style={{ fontSize:13, color:"#9B8A6E", marginTop:2 }}>
                              {lang.wordCount?.toLocaleString() || 0} mots
                            </div>
                          </div>
                          <div style={{ color:"#C4B8A4" }}><ChevronRight /></div>
                        </button>
                      );
                    })}
                  </div>
                )}

                <p style={{ textAlign:"center", color:"#B8A88C", fontSize:12, marginTop:32, fontStyle:"italic" }}>
                  D'autres langues arrivent bient√¥t...
                </p>

                {/* Map button */}
                <button onClick={() => setView("map")} style={{
                  display:"flex", alignItems:"center", justifyContent:"center", gap:8,
                  width:"100%", marginTop:16, padding:"14px 20px",
                  background:"linear-gradient(135deg, #2D2118, #4A3828)",
                  border:"none", borderRadius:14, cursor:"pointer",
                  transition:"all 0.2s", boxShadow:"0 2px 8px rgba(45,33,24,0.15)",
                }}
                onMouseOver={e => { e.currentTarget.style.transform="translateY(-2px)"; e.currentTarget.style.boxShadow="0 6px 16px rgba(45,33,24,0.2)"; }}
                onMouseOut={e => { e.currentTarget.style.transform="translateY(0)"; e.currentTarget.style.boxShadow="0 2px 8px rgba(45,33,24,0.15)"; }}>
                  <MapIcon />
                  <span style={{ color:"white", fontSize:14, fontWeight:600, fontFamily:"'DM Sans', sans-serif" }}>
                    Explorer la carte des langues
                  </span>
                </button>
              </div>
            )}

            {/* MAP VIEW */}
            {view === "map" && (
              <div style={{ animation:"fadeIn 0.3s ease-out", paddingTop:20 }}>
                <button onClick={() => { setView("lang_select"); setMapLang(null); }} style={{
                  display:"flex", alignItems:"center", gap:6, background:"none", border:"none",
                  color:"#8B6D47", fontSize:14, fontWeight:600, cursor:"pointer", padding:"8px 0", marginBottom:16,
                  fontFamily:"'DM Sans', sans-serif",
                }}><ArrowLeft /> Retour</button>

                <h2 style={{ fontFamily:"'Playfair Display', serif", fontSize:24, fontWeight:800, color:"#2D2118", margin:"0 0 4px" }}>
                  Carte des langues
                </h2>
                <p style={{ fontSize:13, color:"#9B8A6E", margin:"0 0 20px" }}>
                  Touchez une r√©gion pour en savoir plus
                </p>

                <div style={{
                  background:"white", borderRadius:20, padding:"0",
                  border:"1px solid #E8E0D4", boxShadow:"0 2px 12px rgba(139,109,71,0.08)",
                  marginBottom:16, overflow:"hidden",
                }}>
                  <LeafletMap
                    selectedMapLang={mapLang}
                    onSelectLang={(name) => setMapLang(mapLang === name ? null : name)}
                  />
                </div>

                {/* Legend */}
                <div style={{ display:"flex", justifyContent:"center", gap:10, marginBottom:16, flexWrap:"wrap" }}>
                  {Object.entries(LANG_GEO).map(([name, geo]) => (
                    <button key={name}
                      onClick={() => setMapLang(mapLang === name ? null : name)}
                      style={{
                        display:"flex", alignItems:"center", gap:6,
                        background: mapLang === name ? geo.color + "15" : "white",
                        border: mapLang === name ? `2px solid ${geo.color}` : "2px solid #E8E0D4",
                        borderRadius:20, padding:"8px 14px", cursor:"pointer",
                        transition:"all 0.2s",
                      }}>
                      <div style={{ width:10, height:10, borderRadius:"50%", background:geo.color }} />
                      <span style={{ fontSize:13, fontWeight:600, color: mapLang === name ? geo.color : "#6B7280",
                        fontFamily:"'DM Sans', sans-serif" }}>{name}</span>
                    </button>
                  ))}
                </div>

                {/* Language detail card */}
                {mapLang && LANG_GEO[mapLang] && (() => {
                  const geo = LANG_GEO[mapLang];
                  const t = LANG_THEMES[mapLang] || defaultTheme;
                  const matchedLang = languages.find(l => l.name === mapLang);
                  return (
                    <div style={{
                      background:"white", borderRadius:20, overflow:"hidden",
                      border:"1px solid #E8E0D4", boxShadow:"0 2px 12px rgba(139,109,71,0.08)",
                      animation:"slideIn 0.25s ease-out",
                    }}>
                      {/* Header */}
                      <div style={{
                        background: t.gradient, padding:"20px 24px",
                        position:"relative", overflow:"hidden",
                      }}>
                        <div style={{ position:"absolute", top:-20, right:-20, width:80, height:80, borderRadius:"50%", background:"rgba(255,255,255,0.06)" }} />
                        <div style={{ display:"flex", alignItems:"center", gap:12 }}>
                          <span style={{ fontSize:32 }}>{t.emoji}</span>
                          <div>
                            <h3 style={{ color:"white", fontSize:22, fontWeight:700, margin:0, fontFamily:"'Playfair Display', serif" }}>{mapLang}</h3>
                            <span style={{ color:"rgba(255,255,255,0.6)", fontSize:12, fontFamily:"'DM Mono', monospace" }}>{geo.family}</span>
                          </div>
                        </div>
                      </div>

                      {/* Body */}
                      <div style={{ padding:"20px 24px" }}>
                        <p style={{ fontSize:14, color:"#5C4A2E", lineHeight:1.6, margin:"0 0 16px", fontFamily:"'Source Serif 4', serif" }}>
                          {geo.description}
                        </p>

                        {/* Stats */}
                        <div style={{ display:"flex", gap:12, marginBottom:16 }}>
                          <div style={{ flex:1, background:"#FDFBF7", borderRadius:12, padding:"12px 14px", textAlign:"center" }}>
                            <div style={{ fontSize:18, fontWeight:800, color:geo.color, fontFamily:"'Playfair Display', serif" }}>{geo.speakers}</div>
                            <div style={{ fontSize:10, color:"#9B8A6E", textTransform:"uppercase", letterSpacing:"0.08em", fontWeight:600, marginTop:2 }}>Locuteurs</div>
                          </div>
                          <div style={{ flex:1, background:"#FDFBF7", borderRadius:12, padding:"12px 14px", textAlign:"center" }}>
                            <div style={{ fontSize:18, fontWeight:800, color:geo.color, fontFamily:"'Playfair Display', serif" }}>{matchedLang?.wordCount?.toLocaleString() || "‚Äî"}</div>
                            <div style={{ fontSize:10, color:"#9B8A6E", textTransform:"uppercase", letterSpacing:"0.08em", fontWeight:600, marginTop:2 }}>Mots</div>
                          </div>
                        </div>

                        {/* Regions */}
                        <div style={{ marginBottom:16 }}>
                          <span style={{ fontSize:11, color:"#9B8A6E", fontWeight:600, letterSpacing:"0.08em", textTransform:"uppercase", fontFamily:"'DM Mono', monospace" }}>
                            R√©gions
                          </span>
                          <div style={{ display:"flex", flexWrap:"wrap", gap:6, marginTop:8 }}>
                            {geo.regions.map((r, i) => (
                              <span key={i} style={{
                                background:geo.color + "12", color:geo.color,
                                fontSize:12, fontWeight:600, padding:"4px 10px",
                                borderRadius:8, fontFamily:"'DM Sans', sans-serif",
                              }}>{r}</span>
                            ))}
                          </div>
                        </div>

                        {/* Open dictionary button */}
                        {matchedLang && (
                          <button onClick={() => selectLanguage(matchedLang)} style={{
                            width:"100%", padding:"14px",
                            background:t.gradient, color:"white",
                            border:"none", borderRadius:12, fontSize:15, fontWeight:700,
                            cursor:"pointer", fontFamily:"'DM Sans', sans-serif",
                            boxShadow:`0 4px 12px ${geo.color}30`,
                          }}>
                            Ouvrir le dictionnaire {mapLang}
                          </button>
                        )}
                      </div>
                    </div>
                  );
                })()}

                {!mapLang && (
                  <div style={{ textAlign:"center", padding:"20px", color:"#9B8A6E" }}>
                    <p style={{ fontSize:14, fontStyle:"italic" }}>
                      S√©lectionnez une langue sur la carte pour voir les d√©tails
                    </p>
                  </div>
                )}
              </div>
            )}

            {/* HOME */}
            {view === "home" && selectedLang && (
              <div style={{ animation:"fadeIn 0.3s ease-out" }}>
                <div style={{ textAlign:"center", paddingTop:48, paddingBottom:32 }}>
                  <div style={{
                    width:72, height:72, borderRadius:20, background:theme.gradient,
                    display:"flex", alignItems:"center", justifyContent:"center",
                    margin:"0 auto 16px", boxShadow:`0 8px 24px ${theme.accent}40`,
                    animation:"float 4s ease-in-out infinite",
                  }}><span style={{ fontSize:32 }}>üìñ</span></div>
                  <h1 style={{ fontFamily:"'Playfair Display', serif", fontSize:32, fontWeight:800, color:"#2D2118", margin:"0 0 4px", lineHeight:1.1 }}>Mon…îk…î</h1>
                  <p style={{ color:"#9B8A6E", fontSize:14, margin:0, fontWeight:500 }}>Dictionnaire Fran√ßais ‚Äî {langName}</p>

                  {/* Switch language button */}
                  <button onClick={switchLanguage} style={{
                    display:"inline-flex", alignItems:"center", gap:6, marginTop:12,
                    background:"#F0EBE3", border:"1px solid #E8E0D4", borderRadius:20,
                    padding:"6px 14px", fontSize:12, fontWeight:600, color:"#8B6D47",
                    cursor:"pointer", fontFamily:"'DM Sans', sans-serif",
                  }}>
                    <GlobeIcon /> Changer de langue
                  </button>
                </div>

                <div style={{
                  display:"flex", justifyContent:"center", gap:24, marginBottom:32,
                  padding:"14px 0", borderTop:"1px solid #E8E0D4", borderBottom:"1px solid #E8E0D4",
                }}>
                  {[
                    { n: stats.words.toLocaleString(), label: "mots" },
                    { n: stats.senses.toLocaleString(), label: "traductions" },
                    { n: "A‚ÄìZ", label: "complet" },
                  ].map((s,i) => (
                    <div key={i} style={{ textAlign:"center" }}>
                      <div style={{ fontSize:22, fontWeight:800, color:theme.accent, fontFamily:"'Playfair Display', serif" }}>{s.n}</div>
                      <div style={{ fontSize:11, color:"#9B8A6E", textTransform:"uppercase", letterSpacing:"0.08em", fontWeight:600 }}>{s.label}</div>
                    </div>
                  ))}
                </div>

                <div style={{ display:"flex", flexDirection:"column", gap:12 }}>
                  {[
                    { icon:<SearchIcon/>, title:"Rechercher un mot", sub:`Fran√ßais ‚Üí ${langName} ou ${langName} ‚Üí Fran√ßais`, grad:"linear-gradient(135deg, #D4A843, #C4912E)", v:"search" },
                    { icon:<BookIcon/>, title:"Parcourir A ‚Äî Z", sub:"Explorer le dictionnaire par lettre", grad:theme.gradient, v:"browse" },
                    { icon:<GradIcon/>, title:"Apprendre", sub:"Cours de grammaire, phrases utiles, vocabulaire", grad:"linear-gradient(135deg, #6B21A8, #9333EA)", v:"courses" },
                  ].map((c,i) => (
                    <button key={i} onClick={async () => {
                      setView(c.v);
                      if (c.v === "courses" && langId) {
                        setLoading(true);
                        try {
                          const coursesData = await supaFetch("courses", `language_id=eq.${langId}&select=*&order=course_order`);
                          setCourses(coursesData);
                        } catch(e) { console.error(e); setCourses([]); }
                        setLoading(false);
                      }
                    }} style={{
                      display:"flex", alignItems:"center", gap:16, width:"100%",
                      background:"white", border:"1px solid #E8E0D4", borderRadius:18,
                      padding:"22px 24px", cursor:"pointer", textAlign:"left",
                      transition:"all 0.2s", boxShadow:"0 2px 8px rgba(139,109,71,0.06)",
                    }}
                    onMouseOver={e => { e.currentTarget.style.transform="translateY(-2px)"; e.currentTarget.style.boxShadow="0 6px 20px rgba(139,109,71,0.1)"; }}
                    onMouseOut={e => { e.currentTarget.style.transform="translateY(0)"; e.currentTarget.style.boxShadow="0 2px 8px rgba(139,109,71,0.06)"; }}>
                      <div style={{ width:48, height:48, borderRadius:14, background:c.grad, display:"flex", alignItems:"center", justifyContent:"center", color:"white", flexShrink:0 }}>{c.icon}</div>
                      <div>
                        <div style={{ fontSize:17, fontWeight:700, color:"#2D2118", fontFamily:"'Playfair Display', serif" }}>{c.title}</div>
                        <div style={{ fontSize:13, color:"#9B8A6E", marginTop:2 }}>{c.sub}</div>
                      </div>
                      <div style={{ marginLeft:"auto", color:"#C4B8A4" }}><ChevronRight /></div>
                    </button>
                  ))}
                </div>

                {wordOfDay && (
                  <div style={{
                    marginTop:24, background:"linear-gradient(135deg, #2D2118, #4A3828)",
                    borderRadius:20, padding:"24px 28px", cursor:"pointer",
                    position:"relative", overflow:"hidden",
                  }} onClick={() => openWord(wordOfDay.id, "home")}>
                    <div style={{ position:"absolute", top:0, right:0, width:"40%", height:"100%", background:"linear-gradient(135deg, transparent, rgba(212,168,67,0.08))" }}/>
                    <span style={{ fontSize:10, color:"#D4A843", fontWeight:700, letterSpacing:"0.15em", textTransform:"uppercase", fontFamily:"'DM Mono', monospace" }}>‚ú¶ MOT DU JOUR</span>
                    <h3 style={{ color:"white", fontSize:26, margin:"8px 0 4px", fontFamily:"'Playfair Display', serif", fontWeight:700 }}>{wordOfDay.french_word}</h3>
                    <p style={{ color:"#D4A843", fontSize:18, margin:0, fontFamily:"'Source Serif 4', serif", fontStyle:"italic" }}>{wordOfDay.dialect_word}</p>
                  </div>
                )}
              </div>
            )}

            {/* SEARCH */}
            {view === "search" && selectedLang && (
              <div style={{ animation:"slideIn 0.25s ease-out", paddingTop:20 }}>
                <button onClick={() => { setView("home"); setQuery(""); setResults([]); setHasSearched(false); }} style={{
                  display:"flex", alignItems:"center", gap:6, background:"none", border:"none",
                  color:"#8B6D47", fontSize:14, fontWeight:600, cursor:"pointer", padding:"8px 0", marginBottom:12,
                }}><ArrowLeft /> Accueil</button>

                <div style={{ display:"flex", background:"#E8E0D4", borderRadius:12, padding:3, marginBottom:16 }}>
                  {[{ key:"french", label:`Fran√ßais ‚Üí ${langName}` },{ key:"dialect", label:`${langName} ‚Üí Fran√ßais` }].map(m => (
                    <button key={m.key} onClick={() => { setSearchMode(m.key); setResults([]); setHasSearched(false); setQuery(""); }} style={{
                      flex:1, padding:"10px 0", border:"none", borderRadius:10, fontSize:12,
                      fontWeight:600, cursor:"pointer", transition:"all 0.2s", fontFamily:"'DM Sans', sans-serif",
                      background: searchMode===m.key ? "white" : "transparent",
                      color: searchMode===m.key ? "#2D2118" : "#9B8A6E",
                      boxShadow: searchMode===m.key ? "0 1px 4px rgba(0,0,0,0.08)" : "none",
                    }}>{m.label}</button>
                  ))}
                </div>

                <div style={{ display:"flex", gap:8, marginBottom:24 }}>
                  <div style={{ flex:1, display:"flex", alignItems:"center", background:"white", borderRadius:14, border:"2px solid #E8E0D4", padding:"0 16px" }}>
                    <span style={{ color:"#B8A88C", marginRight:10, display:"flex" }}><SearchIcon /></span>
                    <input ref={inputRef} value={query}
                      onChange={e => setQuery(e.target.value)}
                      onKeyDown={e => e.key==="Enter" && doSearch()}
                      placeholder={searchMode==="french" ? "Tapez un mot en fran√ßais..." : `Tapez un mot en ${langName.toLowerCase()}...`}
                      style={{ flex:1, border:"none", outline:"none", fontSize:16, padding:"14px 0", background:"transparent", color:"#2D2118", fontFamily:"'DM Sans', sans-serif" }}
                      onFocus={e => e.target.parentElement.style.borderColor="#D4A843"}
                      onBlur={e => e.target.parentElement.style.borderColor="#E8E0D4"}
                    />
                  </div>
                  <button onClick={doSearch} style={{
                    background:"linear-gradient(135deg, #D4A843, #C4912E)", color:"white",
                    border:"none", borderRadius:14, padding:"0 20px", fontSize:15,
                    fontWeight:700, cursor:"pointer", fontFamily:"'DM Sans', sans-serif",
                    boxShadow:"0 2px 8px rgba(212,168,67,0.3)", whiteSpace:"nowrap",
                  }}>Chercher</button>
                </div>

                {loading && <Spinner />}
                {!loading && hasSearched && results.length===0 && (
                  <div style={{ textAlign:"center", padding:"40px 20px", color:"#9B8A6E" }}>
                    <div style={{ fontSize:40, marginBottom:12 }}>üîç</div>
                    <p style={{ fontSize:16, fontWeight:600, margin:"0 0 4px", color:"#5C4A2E" }}>Aucun r√©sultat</p>
                    <p style={{ fontSize:14, margin:0 }}>Essayez un autre mot ou v√©rifiez l'orthographe</p>
                  </div>
                )}
                {!loading && results.length > 0 && (
                  <div>
                    <p style={{ fontSize:12, color:"#9B8A6E", fontWeight:600, letterSpacing:"0.08em", textTransform:"uppercase", margin:"0 0 12px", fontFamily:"'DM Mono', monospace" }}>
                      {results.length} r√©sultat{results.length>1?"s":""}
                    </p>
                    {results.map(w => <ResultRow key={w.id} word={w} onClick={() => openWord(w.id, "search")} />)}
                  </div>
                )}
              </div>
            )}

            {/* BROWSE */}
            {view === "browse" && selectedLang && (
              <div style={{ animation:"slideIn 0.25s ease-out", paddingTop:20 }}>
                <button onClick={() => {
                  if (browseLetter) { setBrowseLetter(null); setBrowseWords([]); }
                  else { setView("home"); }
                }} style={{
                  display:"flex", alignItems:"center", gap:6, background:"none", border:"none",
                  color:"#8B6D47", fontSize:14, fontWeight:600, cursor:"pointer", padding:"8px 0", marginBottom:16,
                }}><ArrowLeft /> {browseLetter ? "Lettres" : "Accueil"}</button>

                {!browseLetter ? (
                  <React.Fragment>
                    <h2 style={{ fontFamily:"'Playfair Display', serif", fontSize:26, fontWeight:800, color:"#2D2118", margin:"0 0 20px" }}>Parcourir</h2>
                    <div style={{ display:"grid", gridTemplateColumns:"repeat(4, 1fr)", gap:10 }}>
                      {LETTERS.map(l => (
                        <button key={l} onClick={() => loadBrowse(l)} style={{
                          background:"white", border:"1px solid #E8E0D4", borderRadius:16,
                          padding:"18px 8px 14px", cursor:"pointer", textAlign:"center",
                          transition:"all 0.15s", boxShadow:"0 1px 3px rgba(139,109,71,0.04)",
                        }}
                        onMouseOver={e => { e.currentTarget.style.borderColor=theme.accent; e.currentTarget.style.transform="translateY(-2px)"; }}
                        onMouseOut={e => { e.currentTarget.style.borderColor="#E8E0D4"; e.currentTarget.style.transform="translateY(0)"; }}>
                          <div style={{ fontSize:28, fontWeight:800, color:theme.accent, fontFamily:"'Playfair Display', serif" }}>{l}</div>
                        </button>
                      ))}
                    </div>
                  </React.Fragment>
                ) : (
                  <React.Fragment>
                    <h2 style={{ fontFamily:"'Playfair Display', serif", fontSize:26, fontWeight:800, color:"#2D2118", margin:"0 0 4px" }}>Lettre {browseLetter}</h2>
                    <p style={{ fontSize:13, color:"#9B8A6E", margin:"0 0 20px", fontWeight:500 }}>{browseWords.length} mot{browseWords.length>1?"s":""}</p>
                    {loading ? <Spinner /> : browseWords.map(w => <ResultRow key={w.id} word={w} onClick={() => openWord(w.id, "browse")} />)}
                  </React.Fragment>
                )}
              </div>
            )}

            {/* DETAIL */}
            {view === "detail" && selectedWordId && (
              <div style={{ paddingTop:20 }}>
                <WordDetail wordId={selectedWordId} langName={langName} onBack={() => { setSelectedWordId(null); setView(prevView); }} />
              </div>
            )}

            {/* COURSES LIST */}
            {view === "courses" && selectedLang && (
              <div style={{ animation:"slideIn 0.25s ease-out", paddingTop:20 }}>
                <button onClick={() => { setView("home"); setCourses([]); }} style={{
                  display:"flex", alignItems:"center", gap:6, background:"none", border:"none",
                  color:"#8B6D47", fontSize:14, fontWeight:600, cursor:"pointer", padding:"8px 0", marginBottom:16,
                  fontFamily:"'DM Sans', sans-serif",
                }}><ArrowLeft /> Accueil</button>

                <h2 style={{ fontFamily:"'Playfair Display', serif", fontSize:26, fontWeight:800, color:"#2D2118", margin:"0 0 4px" }}>
                  Apprendre le {langName}
                </h2>
                <p style={{ fontSize:13, color:"#9B8A6E", margin:"0 0 24px" }}>
                  {courses.length} cours disponibles
                </p>

                {loading ? <Spinner /> : courses.length === 0 ? (
                  <div style={{ textAlign:"center", padding:"40px 20px" }}>
                    <div style={{ fontSize:40, marginBottom:12 }}>üìö</div>
                    <p style={{ fontSize:16, fontWeight:600, color:"#5C4A2E", margin:"0 0 4px" }}>Cours bient√¥t disponibles</p>
                    <p style={{ fontSize:14, color:"#9B8A6E" }}>Les cours pour le {langName} sont en pr√©paration</p>
                  </div>
                ) : (
                  <div style={{ display:"flex", flexDirection:"column", gap:12 }}>
                    {courses.map((course, i) => (
                      <button key={course.id} onClick={async () => {
                        setSelectedCourse(course);
                        setLoading(true);
                        try {
                          const lessonsData = await supaFetch("lessons", `course_id=eq.${course.id}&select=*,lesson_items(id)&order=lesson_order`);
                          setSelectedCourse({ ...course, lessons: lessonsData.map(l => ({ ...l, itemCount: l.lesson_items?.length || 0 })) });
                        } catch(e) { console.error(e); }
                        setLoading(false);
                        setView("course_detail");
                      }} style={{
                        display:"flex", alignItems:"center", gap:16, width:"100%",
                        background:"white", border:"1px solid #E8E0D4", borderRadius:18,
                        padding:"20px 24px", cursor:"pointer", textAlign:"left",
                        transition:"all 0.2s", boxShadow:"0 2px 8px rgba(139,109,71,0.06)",
                      }}
                      onMouseOver={e => { e.currentTarget.style.transform="translateY(-2px)"; e.currentTarget.style.boxShadow="0 6px 20px rgba(139,109,71,0.1)"; }}
                      onMouseOut={e => { e.currentTarget.style.transform="translateY(0)"; e.currentTarget.style.boxShadow="0 2px 8px rgba(139,109,71,0.06)"; }}>
                        <div style={{
                          width:48, height:48, borderRadius:14,
                          background:"linear-gradient(135deg, #6B21A8, #9333EA)",
                          display:"flex", alignItems:"center", justifyContent:"center",
                          fontSize:22, flexShrink:0,
                        }}>{course.icon || "üìö"}</div>
                        <div style={{ flex:1 }}>
                          <div style={{ fontSize:16, fontWeight:700, color:"#2D2118", fontFamily:"'Playfair Display', serif" }}>
                            {course.title}
                          </div>
                          <div style={{ fontSize:12, color:"#9B8A6E", marginTop:3, lineHeight:1.4 }}>
                            {course.description}
                          </div>
                        </div>
                        <div style={{
                          background:"#F3F0FF", color:"#6B21A8", fontSize:11, fontWeight:700,
                          padding:"4px 10px", borderRadius:12, flexShrink:0,
                          fontFamily:"'DM Mono', monospace",
                        }}>
                          {i + 1}/{courses.length}
                        </div>
                      </button>
                    ))}
                  </div>
                )}
              </div>
            )}

            {/* COURSE DETAIL (lesson list) */}
            {view === "course_detail" && selectedCourse && (
              <div style={{ animation:"slideIn 0.25s ease-out", paddingTop:20 }}>
                <button onClick={() => { setView("courses"); setSelectedCourse(null); }} style={{
                  display:"flex", alignItems:"center", gap:6, background:"none", border:"none",
                  color:"#8B6D47", fontSize:14, fontWeight:600, cursor:"pointer", padding:"8px 0", marginBottom:16,
                  fontFamily:"'DM Sans', sans-serif",
                }}><ArrowLeft /> Cours</button>

                <div style={{
                  background:"linear-gradient(135deg, #6B21A8, #9333EA)",
                  borderRadius:20, padding:"24px 28px", marginBottom:20,
                  position:"relative", overflow:"hidden",
                }}>
                  <div style={{ position:"absolute", top:-20, right:-20, width:80, height:80, borderRadius:"50%", background:"rgba(255,255,255,0.06)" }}/>
                  <span style={{ fontSize:28 }}>{selectedCourse.icon || "üìö"}</span>
                  <h2 style={{ color:"white", fontSize:24, fontWeight:700, margin:"8px 0 4px", fontFamily:"'Playfair Display', serif" }}>
                    {selectedCourse.title}
                  </h2>
                  <p style={{ color:"rgba(255,255,255,0.6)", fontSize:13, margin:0 }}>
                    {selectedCourse.lessons?.length || 0} le√ßons
                  </p>
                </div>

                {loading ? <Spinner /> : (
                  <div style={{ display:"flex", flexDirection:"column", gap:8 }}>
                    {selectedCourse.lessons?.map((lesson, i) => (
                      <button key={lesson.id} onClick={async () => {
                        setSelectedLesson(lesson);
                        setLoading(true);
                        setCurrentCardIdx(0);
                        setCardFlipped(false);
                        try {
                          const items = await supaFetch("lesson_items", `lesson_id=eq.${lesson.id}&select=*&order=item_order`);
                          setLessonItems(items);
                        } catch(e) { console.error(e); }
                        setLoading(false);
                        setView("lesson");
                      }} style={{
                        display:"flex", alignItems:"center", width:"100%",
                        background:"white", border:"1px solid #E8E0D4", borderRadius:14,
                        padding:"16px 20px", cursor:"pointer", textAlign:"left",
                        transition:"all 0.15s", boxShadow:"0 1px 2px rgba(139,109,71,0.04)",
                        gap:14,
                      }}
                      onMouseOver={e => { e.currentTarget.style.borderColor="#9333EA"; e.currentTarget.style.boxShadow="0 2px 8px rgba(107,33,168,0.1)"; }}
                      onMouseOut={e => { e.currentTarget.style.borderColor="#E8E0D4"; e.currentTarget.style.boxShadow="0 1px 2px rgba(139,109,71,0.04)"; }}>
                        <div style={{
                          width:36, height:36, borderRadius:10,
                          background:"#F3F0FF", display:"flex", alignItems:"center", justifyContent:"center",
                          fontSize:14, fontWeight:800, color:"#6B21A8", flexShrink:0,
                          fontFamily:"'DM Mono', monospace",
                        }}>{i + 1}</div>
                        <div style={{ flex:1 }}>
                          <div style={{ fontSize:15, fontWeight:600, color:"#2D2118" }}>{lesson.title}</div>
                          <div style={{ fontSize:12, color:"#9B8A6E", marginTop:2 }}>{lesson.itemCount} expressions</div>
                        </div>
                        <div style={{ color:"#C4B8A4" }}><ChevronRight /></div>
                      </button>
                    ))}
                  </div>
                )}
              </div>
            )}

            {/* LESSON (flashcards) */}
            {view === "lesson" && selectedLesson && (
              <div style={{ animation:"slideIn 0.25s ease-out", paddingTop:20 }}>
                <button onClick={() => { setView("course_detail"); setSelectedLesson(null); setLessonItems([]); }} style={{
                  display:"flex", alignItems:"center", gap:6, background:"none", border:"none",
                  color:"#8B6D47", fontSize:14, fontWeight:600, cursor:"pointer", padding:"8px 0", marginBottom:12,
                  fontFamily:"'DM Sans', sans-serif",
                }}><ArrowLeft /> {selectedCourse?.title}</button>

                <h2 style={{ fontFamily:"'Playfair Display', serif", fontSize:22, fontWeight:800, color:"#2D2118", margin:"0 0 4px" }}>
                  {selectedLesson.title}
                </h2>

                {/* Progress bar */}
                <div style={{ display:"flex", alignItems:"center", gap:10, marginBottom:20 }}>
                  <div style={{ flex:1, height:6, background:"#E8E0D4", borderRadius:3, overflow:"hidden" }}>
                    <div style={{
                      width: `${lessonItems.length ? ((currentCardIdx + 1) / lessonItems.length * 100) : 0}%`,
                      height:"100%", background:"linear-gradient(90deg, #6B21A8, #9333EA)",
                      borderRadius:3, transition:"width 0.3s",
                    }} />
                  </div>
                  <span style={{ fontSize:12, fontWeight:600, color:"#9B8A6E", fontFamily:"'DM Mono', monospace", flexShrink:0 }}>
                    {currentCardIdx + 1}/{lessonItems.length}
                  </span>
                </div>

                {loading ? <Spinner /> : lessonItems.length > 0 && (() => {
                  const item = lessonItems[currentCardIdx];
                  return (
                    <div>
                      {/* Flashcard */}
                      <div
                        onClick={() => setCardFlipped(!cardFlipped)}
                        style={{
                          background: cardFlipped
                            ? "linear-gradient(135deg, #6B21A8, #9333EA)"
                            : "white",
                          borderRadius:20, padding:"32px 28px", minHeight:200,
                          display:"flex", flexDirection:"column", justifyContent:"center", alignItems:"center",
                          cursor:"pointer", border: cardFlipped ? "none" : "2px solid #E8E0D4",
                          boxShadow: cardFlipped ? "0 8px 32px rgba(107,33,168,0.2)" : "0 2px 12px rgba(139,109,71,0.08)",
                          transition:"all 0.3s", position:"relative",
                          textAlign:"center",
                        }}>
                        {!cardFlipped && (
                          <span style={{ position:"absolute", top:16, left:20, fontSize:10, fontWeight:700,
                            color:"#9B8A6E", letterSpacing:"0.1em", fontFamily:"'DM Mono', monospace" }}>
                            FRAN√áAIS
                          </span>
                        )}
                        {cardFlipped && (
                          <span style={{ position:"absolute", top:16, left:20, fontSize:10, fontWeight:700,
                            color:"rgba(255,255,255,0.5)", letterSpacing:"0.1em", fontFamily:"'DM Mono', monospace" }}>
                            {langName.toUpperCase()}
                          </span>
                        )}

                        <p style={{
                          fontSize: cardFlipped ? 26 : 22, fontWeight:700,
                          color: cardFlipped ? "white" : "#2D2118",
                          fontFamily:"'Playfair Display', serif", lineHeight:1.3,
                          margin:"12px 0 0",
                        }}>
                          {cardFlipped ? item.dialect : item.french}
                        </p>

                        {/* Example sentence */}
                        {cardFlipped && item.example_dialect && (
                          <div style={{
                            marginTop:16, padding:"12px 16px", background:"rgba(255,255,255,0.12)",
                            borderRadius:12, width:"100%",
                          }}>
                            <p style={{ fontSize:14, color:"rgba(255,255,255,0.9)", fontStyle:"italic", margin:0, lineHeight:1.5, fontFamily:"'Source Serif 4', serif" }}>
                              ¬´ {item.example_dialect} ¬ª
                            </p>
                            {item.example_french && (
                              <p style={{ fontSize:12, color:"rgba(255,255,255,0.5)", margin:"6px 0 0" }}>
                                {item.example_french}
                              </p>
                            )}
                          </div>
                        )}

                        {!cardFlipped && item.example_french && (
                          <div style={{ marginTop:16, padding:"12px 16px", background:"#FDFBF7", borderRadius:12, width:"100%", borderLeft:"3px solid #D4A843" }}>
                            <p style={{ fontSize:14, color:"#5C4A2E", fontStyle:"italic", margin:0, lineHeight:1.5, fontFamily:"'Source Serif 4', serif" }}>
                              ¬´ {item.example_french} ¬ª
                            </p>
                          </div>
                        )}

                        <p style={{
                          fontSize:11, color: cardFlipped ? "rgba(255,255,255,0.4)" : "#B8A88C",
                          marginTop:16, fontWeight:500,
                        }}>
                          {cardFlipped ? "Touchez pour voir le fran√ßais" : "Touchez pour voir la traduction"}
                        </p>
                      </div>

                      {/* Navigation */}
                      <div style={{ display:"flex", gap:12, marginTop:20 }}>
                        <button
                          onClick={() => { setCurrentCardIdx(Math.max(0, currentCardIdx - 1)); setCardFlipped(false); }}
                          disabled={currentCardIdx === 0}
                          style={{
                            flex:1, padding:"14px", border:"2px solid #E8E0D4", borderRadius:14,
                            background:"white", fontSize:15, fontWeight:700, cursor:"pointer",
                            color: currentCardIdx === 0 ? "#D0C8B8" : "#2D2118",
                            fontFamily:"'DM Sans', sans-serif", transition:"all 0.2s",
                          }}>
                          ‚Üê Pr√©c√©dent
                        </button>
                        <button
                          onClick={() => {
                            if (currentCardIdx < lessonItems.length - 1) {
                              setCurrentCardIdx(currentCardIdx + 1);
                              setCardFlipped(false);
                            } else {
                              // Finished ‚Äî go back to course detail
                              setView("course_detail");
                              setSelectedLesson(null);
                              setLessonItems([]);
                            }
                          }}
                          style={{
                            flex:1, padding:"14px", border:"none", borderRadius:14,
                            background: currentCardIdx === lessonItems.length - 1
                              ? "linear-gradient(135deg, #16A34A, #22C55E)"
                              : "linear-gradient(135deg, #6B21A8, #9333EA)",
                            color:"white", fontSize:15, fontWeight:700, cursor:"pointer",
                            fontFamily:"'DM Sans', sans-serif",
                            boxShadow: "0 2px 8px rgba(107,33,168,0.3)",
                          }}>
                          {currentCardIdx === lessonItems.length - 1 ? "‚úì Termin√©" : "Suivant ‚Üí"}
                        </button>
                      </div>

                      {/* Item list (scrollable) */}
                      <div style={{ marginTop:24 }}>
                        <p style={{ fontSize:12, color:"#9B8A6E", fontWeight:600, letterSpacing:"0.08em", textTransform:"uppercase", margin:"0 0 10px", fontFamily:"'DM Mono', monospace" }}>
                          Toutes les expressions
                        </p>
                        <div style={{ maxHeight:300, overflowY:"auto", borderRadius:14, border:"1px solid #E8E0D4" }}>
                          {lessonItems.map((it, idx) => (
                            <div key={it.id}
                              onClick={() => { setCurrentCardIdx(idx); setCardFlipped(false); }}
                              style={{
                                padding:"12px 16px", cursor:"pointer",
                                background: idx === currentCardIdx ? "#F3F0FF" : "white",
                                borderBottom: idx < lessonItems.length - 1 ? "1px solid #F0EBE3" : "none",
                                transition:"background 0.2s",
                              }}>
                              <div style={{ fontSize:14, fontWeight: idx === currentCardIdx ? 700 : 500, color:"#2D2118" }}>
                                {it.french}
                              </div>
                              <div style={{ fontSize:13, color:"#6B21A8", marginTop:2 }}>
                                {it.dialect}
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    </div>
                  );
                })()}
              </div>
            )}
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
